generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Category {
  id           String    @id @default(uuid())
  name         String    @db.VarChar(255)
  slug         String    @unique @db.VarChar(255)
  icon         String?   @db.VarChar(100)
  description  String?
  productCount Int       @default(0) @map("product_count")
  createdAt    DateTime  @default(now()) @map("created_at")
  products     Product[]

  @@map("categories")
}

model Product {
  id                String             @id @default(uuid())
  name              String             @db.VarChar(255)
  slug              String             @unique @db.VarChar(255)
  description       String?
  price             Decimal            @db.Decimal(15, 2)
  originalPrice     Decimal?           @map("original_price") @db.Decimal(15, 2)
  images            String[]           @default([])
  categoryId        String?            @map("category_id")
  brand             String?            @db.VarChar(255)
  specs             Json               @default("{}")
  stock             Int                @default(0)
  rating            Decimal            @default(0) @db.Decimal(2, 1)
  reviewCount       Int                @default(0) @map("review_count")
  isNew             Boolean            @default(false) @map("is_new")
  isFeatured        Boolean            @default(false) @map("is_featured")
  discount          Int                @default(0)
  createdAt         DateTime           @default(now()) @map("created_at")
  lowStockThreshold Int                @default(10) @map("low_stock_threshold")
  cartItems         CartItem[]
  orderItems        OrderItem[]
  category          Category?          @relation(fields: [categoryId], references: [id])
  reviews           Review[]
  stockTransactions StockTransaction[]
  wishlist          Wishlist[]

  @@index([categoryId], map: "idx_products_category")
  @@index([slug], map: "idx_products_slug")
  @@map("products")
}

model User {
  id                String             @id @default(uuid())
  email             String             @unique @db.VarChar(255)
  password          String             @db.VarChar(255)
  name              String             @db.VarChar(255)
  avatar            String?
  phone             String?            @db.VarChar(20)
  address           String?
  createdAt         DateTime           @default(now()) @map("created_at")
  isActive          Boolean            @default(true) @map("is_active")
  role              UserRole           @default(user)
  points            Int                @default(0)
  tier              String             @default("bronze") @db.VarChar(20)
  totalSpent        Decimal            @default(0) @map("total_spent") @db.Decimal(15, 2)
  orderCount        Int                @default(0) @map("order_count")
  note              String?
  cartItems         CartItem[]
  chatMessages      ChatMessage[]      @relation("ChatMessages")
  staffChats        ChatSession[]      @relation("StaffChats")
  userChats         ChatSession[]      @relation("UserChats")
  notifications     Notification[]
  orders            Order[]
  promotion_usage   PromotionUsage[]
  pushSubscriptions PushSubscription[]
  reviews           Review[]
  stockTransactions StockTransaction[]
  wishlist          Wishlist[]

  @@index([tier], map: "idx_users_tier")
  @@index([points], map: "idx_users_points")
  @@map("users")
}

model StockTransaction {
  id          String               @id @default(uuid())
  productId   String               @map("product_id")
  userId      String               @map("user_id")
  type        StockTransactionType
  quantity    Int
  reason      String?              @db.VarChar(500)
  reference   String?              @db.VarChar(255)
  stockBefore Int                  @map("stock_before")
  stockAfter  Int                  @map("stock_after")
  createdAt   DateTime             @default(now()) @map("created_at")
  product     Product              @relation(fields: [productId], references: [id], onDelete: Cascade)
  user        User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([productId], map: "idx_stock_product")
  @@index([userId], map: "idx_stock_user")
  @@index([createdAt], map: "idx_stock_created")
  @@map("stock_transactions")
}

model PendingRegistration {
  id        String   @id @default(uuid())
  email     String   @unique @db.VarChar(255)
  password  String   @db.VarChar(255)
  name      String   @db.VarChar(255)
  otp       String   @db.VarChar(6)
  otpHash   String   @map("otp_hash") @db.VarChar(255)
  expiresAt DateTime @map("expires_at")
  attempts  Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")

  @@map("pending_registrations")
}

model PasswordReset {
  id        String   @id @default(uuid())
  email     String   @unique @db.VarChar(255)
  otpHash   String   @map("otp_hash") @db.VarChar(255)
  expiresAt DateTime @map("expires_at")
  attempts  Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")

  @@map("password_resets")
}

model Supplier {
  id          String   @id @default(uuid())
  name        String   @db.VarChar(255)
  contactName String?  @map("contact_name") @db.VarChar(255)
  email       String?  @db.VarChar(255)
  phone       String?  @db.VarChar(50)
  address     String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  products    ProductSupplier[]

  @@map("suppliers")
}

model ProductSupplier {
  id           String   @id @default(uuid())
  productId    String   @map("product_id")
  supplierId   String   @map("supplier_id")
  costPrice    Decimal? @map("cost_price") @db.Decimal(15, 2)
  leadTimeDays Int?     @map("lead_time_days")
  createdAt    DateTime @default(now()) @map("created_at")
  supplier     Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@unique([productId, supplierId])
  @@map("product_suppliers")
}

model UserAddress {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  name      String   @db.VarChar(255)
  phone     String   @db.VarChar(50)
  address   String
  isDefault Boolean  @default(false) @map("is_default")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("user_addresses")
}

model OrderReturn {
  id           String       @id @default(uuid())
  orderId      String       @map("order_id")
  userId       String       @map("user_id")
  reason       String
  status       String       @default("pending") @db.VarChar(50)
  refundAmount Decimal?     @map("refund_amount") @db.Decimal(15, 2)
  staffNote    String?      @map("staff_note")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime?    @map("updated_at")
  items        ReturnItem[]

  @@map("order_returns")
}

model ReturnItem {
  id          String      @id @default(uuid())
  returnId    String      @map("return_id")
  orderItemId String?     @map("order_item_id")
  productId   String      @map("product_id")
  quantity    Int
  reason      String?
  orderReturn OrderReturn @relation(fields: [returnId], references: [id], onDelete: Cascade)

  @@map("return_items")
}

model OrderNote {
  id        String   @id @default(uuid())
  orderId   String   @map("order_id")
  staffId   String   @map("staff_id")
  note      String
  createdAt DateTime @default(now()) @map("created_at")

  @@map("order_notes")
}

model PointsHistory {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  points      Int
  type        String   @db.VarChar(50)
  description String?
  orderId     String?  @map("order_id")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@map("points_history")
}

model ProductQuestion {
  id        String   @id @default(uuid())
  productId String   @map("product_id")
  userId    String   @map("user_id")
  question  String
  answer    String?
  answeredBy String? @map("answered_by")
  answeredAt DateTime? @map("answered_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([productId])
  @@map("product_questions")
}

model CartItem {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  productId String   @map("product_id")
  quantity  Int      @default(1)
  createdAt DateTime @default(now()) @map("created_at")
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId], map: "idx_cart_user")
  @@map("cart_items")
}

model Order {
  id              String           @id @default(uuid())
  userId          String?          @map("user_id")
  total           Decimal          @db.Decimal(15, 2)
  status          OrderStatus      @default(pending)
  shippingAddress String           @map("shipping_address")
  paymentMethod   String           @map("payment_method") @db.VarChar(100)
  createdAt       DateTime         @default(now()) @map("created_at")
  note            String?
  phone           String           @db.VarChar(20)
  recipientName   String           @map("recipient_name") @db.VarChar(255)
  discountAmount  Decimal?         @default(0) @map("discount_amount") @db.Decimal(15, 2)
  promotion_id    String?          @db.Uuid
  subtotal        Decimal?         @db.Decimal(12, 2)
  trackingCode    String?          @map("tracking_code") @db.VarChar(100)
  shippingCarrier String?          @map("shipping_carrier") @db.VarChar(100)
  shippingFee     Decimal?         @default(0) @map("shipping_fee") @db.Decimal(12, 2)
  orderItems      OrderItem[]
  promotions      Promotion?       @relation(fields: [promotion_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  user            User?            @relation(fields: [userId], references: [id])
  promotion_usage PromotionUsage[]

  @@index([userId], map: "idx_orders_user")
  @@index([createdAt], map: "idx_orders_created_at")
  @@index([status], map: "idx_orders_status")
  @@index([createdAt, status], map: "idx_orders_created_status")
  @@map("orders")
}

model OrderItem {
  id        String   @id @default(uuid())
  orderId   String   @map("order_id")
  productId String?  @map("product_id")
  quantity  Int
  price     Decimal  @db.Decimal(15, 2)
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product   Product? @relation(fields: [productId], references: [id])

  @@map("order_items")
}

model Review {
  id        String        @id @default(uuid())
  userId    String?       @map("user_id")
  productId String        @map("product_id")
  rating    Int
  comment   String?
  createdAt DateTime      @default(now()) @map("created_at")
  images    ReviewImage[]
  product   Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User?         @relation(fields: [userId], references: [id])

  @@index([productId], map: "idx_reviews_product")
  @@map("reviews")
}

model ReviewImage {
  id        String   @id @default(uuid())
  reviewId  String   @map("review_id")
  url       String
  publicId  String?  @map("public_id") @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at")
  review    Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@index([reviewId], map: "idx_review_images_review")
  @@map("review_images")
}

model Wishlist {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  productId String   @map("product_id")
  createdAt DateTime @default(now()) @map("created_at")
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId], map: "idx_wishlist_user")
  @@map("wishlist")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  type      String   @db.VarChar(50)
  title     String   @db.VarChar(255)
  message   String
  data      Json?
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead], map: "idx_notifications_user_read")
  @@map("notifications")
}

model PushSubscription {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  endpoint  String   @unique
  p256dh    String
  auth      String   @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_push_subscriptions_user")
  @@map("push_subscriptions")
}

model ChatSession {
  id        String            @id @default(uuid())
  userId    String            @map("user_id")
  staffId   String?           @map("staff_id")
  status    ChatSessionStatus @default(waiting)
  createdAt DateTime          @default(now()) @map("created_at")
  closedAt  DateTime?         @map("closed_at")
  messages  ChatMessage[]
  staff     User?             @relation("StaffChats", fields: [staffId], references: [id])
  user      User              @relation("UserChats", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_chat_sessions_user")
  @@index([staffId], map: "idx_chat_sessions_staff")
  @@index([status], map: "idx_chat_sessions_status")
  @@map("chat_sessions")
}

model ChatMessage {
  id        String      @id @default(uuid())
  sessionId String      @map("session_id")
  senderId  String      @map("sender_id")
  content   String
  createdAt DateTime    @default(now()) @map("created_at")
  sender    User        @relation("ChatMessages", fields: [senderId], references: [id], onDelete: Cascade)
  session   ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId], map: "idx_chat_messages_session")
  @@index([senderId], map: "idx_chat_messages_sender")
  @@map("chat_messages")
}

model Promotion {
  id            String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code          String           @unique @db.VarChar(50)
  name          String           @db.VarChar(255)
  description   String?
  type          String           @db.VarChar(20)
  value         Decimal          @db.Decimal(12, 2)
  minOrderValue Decimal?         @default(0) @map("min_order_value") @db.Decimal(12, 2)
  maxDiscount   Decimal?         @map("max_discount") @db.Decimal(12, 2)
  usageLimit    Int?             @map("usage_limit")
  usedCount     Int?             @default(0) @map("used_count")
  startDate     DateTime?        @map("start_date") @db.Timestamptz(6)
  endDate       DateTime?        @map("end_date") @db.Timestamptz(6)
  isActive      Boolean?         @default(true) @map("is_active")
  createdAt     DateTime?        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime?        @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  orders        Order[]
  usages        PromotionUsage[]

  @@index([code], map: "idx_promotions_code")
  @@index([isActive, startDate, endDate], map: "idx_promotions_active")
  @@map("promotions")
}

model PromotionUsage {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  promotionId    String    @map("promotion_id") @db.Uuid
  userId         String?   @map("user_id")
  orderId        String?   @map("order_id")
  discountAmount Decimal   @map("discount_amount") @db.Decimal(12, 2)
  createdAt      DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  orders         Order?    @relation(fields: [orderId], references: [id], onUpdate: NoAction)
  promotion      Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users          User?     @relation(fields: [userId], references: [id], onUpdate: NoAction)

  @@index([promotionId], map: "idx_promotion_usage_promotion")
  @@map("promotion_usage")
}

enum OrderStatus {
  pending
  awaiting_payment
  confirmed
  shipping
  delivered
  cancelled
}

enum UserRole {
  user
  admin
  sales
  warehouse
}

enum StockTransactionType {
  import
  export
  adjust
  order
  return
}

enum ChatSessionStatus {
  waiting
  active
  closed
}
